import Standard.Buffer (
    Buffer,
    allocateEmpty,
    destroyEmpty,
    initialize,
    length,
    nth,
    destroyFree,
    fill,
    storeNth,
    swapNth
);
import Standard.Test.Unit (
    assertTrue,
    assertSuccess,
    assertFailure,
    suiteHeading,
    testHeading
);

module body Standard.Test.Buffer is
    function bufferTestSuite(): Unit is
        suiteHeading("Standard.Buffer");
        basicLifecycleTest();
        initializeTest();
        storeTest();
        swapNthTest();
        fillTest();
        return nil;
    end;

    function basicLifecycleTest(): Unit is
        testHeading("Basic lifecycle: allocateEmpty and destroyEmpty");
        let b: Buffer[Int32] := allocateEmpty();
        destroyEmpty(b);
        assertSuccess("Basic lifecycle done.");
        return nil;
    end;

    function initializeTest(): Unit is
        testHeading("initialize, length, nth, and destroyFree");
        let b: Buffer[Int32] := initialize(3, 10);
        assertTrue(length(&b) = 3, "length = 3");
        assertTrue(nth(&b, 0) = 10, "[0] = 10");
        assertTrue(nth(&b, 1) = 10, "[1] = 10");
        assertTrue(nth(&b, 2) = 10, "[2] = 10");
        destroyFree(b);
        assertSuccess("destroyFree complete");
        return nil;
    end;

    function storeTest(): Unit is
        testHeading("storeNth");
        let b: Buffer[Int32] := initialize(1, 10);
        assertTrue(length(&b) = 1, "length = 1");
        assertTrue(nth(&b, 0) = 10, "[0] = 10");
        storeNth(&!b, 0, 20);
        assertTrue(nth(&b, 0) = 20, "[0] = 20");
        destroyFree(b);
        assertSuccess("destroyFree complete");
        return nil;
    end;

    function swapNthTest(): Unit is
        testHeading("swapNth");
        let b: Buffer[Int32] := initialize(1, 10);
        assertTrue(length(&b) = 1, "length = 1");
        assertTrue(nth(&b, 0) = 10, "[0] = 10");
        let old: Int32 := swapNth(&!b, 0, 20);
        assertTrue(old = 10, "old = 10");
        assertTrue(nth(&b, 0) = 20, "[0] = 20");
        destroyFree(b);
        assertSuccess("destroyFree complete");
        return nil;
    end;

    function fillTest(): Unit is
        testHeading("initialize then fill");
        let b: Buffer[Int32] := initialize(3, 10);
        fill(&!b, 20);
        assertTrue(length(&b) = 3, "length = 3");
        assertTrue(nth(&b, 0) = 20, "[0] = 20");
        assertTrue(nth(&b, 1) = 20, "[1] = 20");
        assertTrue(nth(&b, 2) = 20, "[2] = 20");
        destroyFree(b);
        assertSuccess("destroyFree complete");
        return nil;
    end;
end module body.